name: AI Collaboration

on:
  push:
    branches: [dev, main]
  issues:
    types: [opened, labeled, commented]
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze-changes:
    name: Analyze Changes and Route to AI
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed components
        id: changes
        run: |
          echo "Analyzing changes in ${{ github.ref_name }}..."
          
          # Check what changed
          CONTRACTS_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -c "^contracts/" || echo "0")
          FRONTEND_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -c "^client/" || echo "0")
          BACKEND_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -c "^server/" || echo "0")
          SCRIPTS_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -c "^scripts/" || echo "0")
          
          echo "contracts=$CONTRACTS_CHANGED" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "scripts=$SCRIPTS_CHANGED" >> $GITHUB_OUTPUT
          
          # Get commit info (title only to avoid multiline issues)
          echo "message=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Route to appropriate AI
        run: |
          echo "## ğŸ¤– AI Collaboration Routing"
          echo ""
          echo "**Commit:** ${{ steps.changes.outputs.message }}"
          echo "**Author:** ${{ steps.changes.outputs.author }}"
          echo "**Branch:** ${{ github.ref_name }}"
          echo ""
          echo "### Changed Components:"
          echo "- ğŸ“œ Contracts: ${{ steps.changes.outputs.contracts }} files"
          echo "- ğŸ¨ Frontend: ${{ steps.changes.outputs.frontend }} files"
          echo "- âš™ï¸ Backend: ${{ steps.changes.outputs.backend }} files"
          echo "- ğŸ”§ Scripts: ${{ steps.changes.outputs.scripts }} files"
          echo ""
          
          # Determine next action
          if [ "${{ steps.changes.outputs.contracts }}" != "0" ]; then
            echo "ğŸ“‹ **Action:** Cursor should integrate new contract changes"
            echo "**Assignee:** @cursor"
          elif [ "${{ steps.changes.outputs.frontend }}" != "0" ] || [ "${{ steps.changes.outputs.backend }}" != "0" ]; then
            if [[ "${{ steps.changes.outputs.message }}" == *"Codex"* ]]; then
              echo "ğŸ“‹ **Action:** No action needed (contract-only change)"
            else
              echo "ğŸ“‹ **Action:** Replit should deploy to ${{ github.ref_name == 'main' && 'production' || 'staging' }}"
              echo "**Assignee:** @replit"
            fi
          fi

  issue-task-notification:
    name: Notify AI on Issue Assignment
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    
    steps:
      - name: Check issue labels
        run: |
          echo "## ğŸ·ï¸ Issue Task Assignment"
          echo ""
          echo "**Issue:** ${{ github.event.issue.title }}"
          echo "**Labels:** ${{ github.event.issue.labels }}"
          echo ""
          
          # Check for AI labels
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          
          if [[ $LABELS == *"@codex"* ]]; then
            echo "ğŸ“‹ **Assigned to:** Codex AI (Smart Contracts)"
            echo "**Action:** Review and implement contract requirements"
          elif [[ $LABELS == *"@cursor"* ]]; then
            echo "ğŸ“‹ **Assigned to:** Cursor AI (Application Development)"
            echo "**Action:** Implement frontend/backend features"
          elif [[ $LABELS == *"@replit"* ]]; then
            echo "ğŸ“‹ **Assigned to:** Replit AI (Deployment)"
            echo "**Action:** Deploy and verify changes"
          else
            echo "âš ï¸ **No AI assigned** - Please add @codex, @cursor, or @replit label"
          fi

  pr-collaboration:
    name: PR Collaboration Info
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Analyze PR
        run: |
          echo "## ğŸ”„ Pull Request Collaboration"
          echo ""
          echo "**PR:** ${{ github.event.pull_request.title }}"
          echo "**Author:** ${{ github.event.pull_request.user.login }}"
          echo "**Base:** ${{ github.event.pull_request.base.ref }}"
          echo "**Head:** ${{ github.event.pull_request.head.ref }}"
          echo ""
          
          # Detect AI from branch or title
          BRANCH="${{ github.event.pull_request.head.ref }}"
          TITLE="${{ github.event.pull_request.title }}"
          
          if [[ $BRANCH == *"codex"* ]] || [[ $TITLE == *"Codex"* ]]; then
            echo "ğŸ¤– **Author AI:** Codex"
            echo "ğŸ“‹ **Review needed:** Cursor (integration check)"
          elif [[ $BRANCH == *"cursor"* ]] || [[ $TITLE == *"Cursor"* ]]; then
            echo "ğŸ¤– **Author AI:** Cursor"
            echo "ğŸ“‹ **Review needed:** Codex (contract compatibility)"
          fi
          
          echo ""
          echo "After review, merge and notify Replit for deployment."

